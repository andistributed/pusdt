(function () {
    'use strict';

    // 全局变量
    let countdownTimer = null;
    let statusCheckTimer = null;
    let totalSeconds = null;
    let paymentConfig = {};

    // 初始化配置
    function initConfig(config) {
        paymentConfig = config;
        totalSeconds = config.expire;
    }

    // 生成二维码
    function generateQRCode() {
        const qrContainer = document.getElementById('qrcode');
        // 骨架动画
        qrContainer.innerHTML = '<div id="qr-skeleton" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;"><div style="width:48px;height:48px;border:4px solid #e2e8f0;border-top:4px solid #26a17b;border-radius:50%;animation:spin 1s linear infinite;"></div></div>';
        setTimeout(function () {
            qrContainer.innerHTML = '';
            const containerWidth = qrContainer.offsetWidth;
            const qrSize = Math.min(containerWidth - 10, 150);
            $('#qrcode').qrcode({
                text: paymentConfig.address,
                width: qrSize,
                height: qrSize,
                foreground: "#000000",
                background: "#ffffff",
                typeNumber: -1
            });
        }, 600);
    }

    // 复制地址
    function copyAddress() {
        const address = document.getElementById('walletAddress').textContent;
        const btn = document.querySelector('.copy-btn');
        // 波纹动画
        const ripple = document.createElement('span');
        ripple.className = 'ripple';
        ripple.style.position = 'absolute';
        ripple.style.left = '50%';
        ripple.style.top = '50%';
        ripple.style.transform = 'translate(-50%, -50%)';
        ripple.style.width = ripple.style.height = '120px';
        ripple.style.background = 'rgba(38,161,123,0.18)';
        ripple.style.borderRadius = '50%';
        ripple.style.pointerEvents = 'none';
        ripple.style.animation = 'ripple-anim 0.5s linear';
        btn.style.position = 'relative';
        btn.appendChild(ripple);
        setTimeout(()=>{ if(ripple.parentNode) ripple.parentNode.removeChild(ripple); }, 500);
        navigator.clipboard.writeText(address).then(function () {
            const originalText = btn.textContent;
            btn.textContent = '已复制!';
            btn.style.background = '#48bb78';
            // 气泡提示
            const bubble = document.createElement('div');
            bubble.textContent = '地址已复制';
            bubble.style.position = 'absolute';
            bubble.style.top = '-36px';
            bubble.style.left = '50%';
            bubble.style.transform = 'translateX(-50%)';
            bubble.style.background = '#232526';
            bubble.style.color = '#fff';
            bubble.style.padding = '4px 14px';
            bubble.style.borderRadius = '8px';
            bubble.style.fontSize = '13px';
            bubble.style.boxShadow = '0 2px 8px rgba(35,37,38,0.10)';
            bubble.style.opacity = '0';
            bubble.style.transition = 'opacity 0.2s, top 0.2s';
            bubble.style.whiteSpace = 'nowrap';
            btn.appendChild(bubble);
            setTimeout(()=>{ bubble.style.opacity = '1'; bubble.style.top = '-48px'; }, 10);
            setTimeout(()=>{ bubble.style.opacity = '0'; bubble.style.top = '-36px'; }, 1800);
            setTimeout(()=>{ if(bubble.parentNode) bubble.parentNode.removeChild(bubble); }, 2100);
            setTimeout(function () {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 2000);
        }).catch(function (err) {
            console.error('复制失败: ', err);
            // 降级方案
            const textArea = document.createElement('textarea');
            textArea.value = address;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = '已复制!';
                btn.style.background = '#48bb78';
                setTimeout(function () {
                    btn.textContent = originalText;
                    btn.style.background = '#667eea';
                }, 2000);
            } catch (err) {
                alert('复制失败，请手动复制地址');
            }
            document.body.removeChild(textArea);
        });
    }

    // 倒计时
    function startCountdown() {
        const minutesEl = document.getElementById('minutes');
        const secondsEl = document.getElementById('seconds');
        function animateNumber(el, newVal) {
            el.classList.remove('count-anim');
            void el.offsetWidth;
            el.classList.add('count-anim');
            el.textContent = newVal;
        }
        function updateDisplay() {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            if (totalSeconds <= 0) {
                animateNumber(minutesEl, '00');
                animateNumber(secondsEl, '00');
            } else {
                animateNumber(minutesEl, minutes.toString().padStart(2, '0'));
                animateNumber(secondsEl, seconds.toString().padStart(2, '0'));
            }
            if (totalSeconds <= 300) {
                document.querySelector('.countdown-banner').style.background = 'linear-gradient(135deg, #ff4757, #ff3838)';
            }
            if (totalSeconds <= 60) {
                document.querySelector('.countdown-banner').style.animation = 'urgentBlink 1s infinite';
            }
        }
        countdownTimer = setInterval(function () {
            totalSeconds--;
            updateDisplay();
            if (totalSeconds <= 0) {
                clearInterval(countdownTimer);
                clearInterval(statusCheckTimer);
                showTimeoutMessage();
            }
        }, 1000);
        updateDisplay();
    }

    // 支付超时
    function showTimeoutMessage() {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(35,37,38,0.85);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeInModal 0.4s cubic-bezier(.4,2,.6,1) both;
        `;
        const modal = document.createElement('div');
        modal.style.cssText = `
            background: linear-gradient(120deg,#fff,#e9ecef 100%);
            padding: 36px 24px 30px 24px;
            border-radius: 18px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.18);
            animation: popInModal 0.5s cubic-bezier(.4,2,.6,1) both;
        `;
        modal.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 20px;">⏰</div>
            <h3 style="color: #e53e3e; margin-bottom: 15px;">支付时间已过期</h3>
            <p style="color: #666; margin-bottom: 25px; line-height: 1.5;">
                很抱歉，支付时间已超时。<br>
                请重新发起支付或联系客服处理。
            </p>
            <button onclick="location.href='${paymentConfig.return_url}'" style="
                background: linear-gradient(90deg,#26a17b 0%,#38cf91 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 15px;
                font-weight: 700;
                margin-right: 10px;
                box-shadow: 0 2px 8px rgba(38,161,123,0.10);
                transition: background 0.2s, transform 0.2s;">返回商户平台</button>
        `;
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
    }

    // 支付成功
    function showSuccessMessage(data) {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(35,37,38,0.85);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeInModal 0.4s cubic-bezier(.4,2,.6,1) both;
        `;
        const modal = document.createElement('div');
        modal.style.cssText = `
            background: linear-gradient(120deg,#fff,#e9ecef 100%);
            padding: 36px 24px 30px 24px;
            border-radius: 18px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.18);
            animation: popInModal 0.5s cubic-bezier(.4,2,.6,1) both;
        `;
        modal.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 20px;">✅</div>
            <h3 style="color: #48bb78; margin-bottom: 15px;">支付成功！</h3>
            <p style="color: #666; margin-bottom: 20px; line-height: 1.5;">
                您的支付已确认，交易哈希：<br>
                <code style="background: #e6f0fa; color: #2563eb; padding: 4px 8px; border-radius: 4px; font-size: 12px; word-break: break-all;">
                    ${data.trade_hash || '处理中...'}
                </code>
            </p>
            <button onclick="location.href='${data.return_url || '/'}'" style="
                background: linear-gradient(90deg,#26a17b 0%,#38cf91 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 15px;
                font-weight: 700;
                box-shadow: 0 2px 8px rgba(38,161,123,0.10);
                transition: background 0.2s, transform 0.2s;">返回商户平台</button>
        `;
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        if (countdownTimer) clearInterval(countdownTimer);
        if (statusCheckTimer) clearInterval(statusCheckTimer);
    }

    // 检查支付状态
    function checkPaymentStatus() {
        $.ajax({
            type: "GET",
            dataType: "json",
            url: "/pay/check-status/" + paymentConfig.trade_id,
            success: function (data) {
                if (data.status === 1) {
                    return setTimeout(checkPaymentStatus, 5000);  // 等待支付
                }
                if (data.status === 2) {
                    return showSuccessMessage(data);  // 支付成功
                }
                if (data.status === 3) {
                    return showTimeoutMessage(); // 支付超时
                }
            }
        });
    }

    // 初始化函数
    function init(config) {
        initConfig(config);
        generateQRCode();
        startCountdown();
        setTimeout(checkPaymentStatus, 2000);
    }

    // 暴露全局函数
    window.copyAddress = copyAddress;
    window.Payment = {
        init: init
    };

    // 动画样式注入
    if (!document.getElementById('usdt-anim-style')) {
        const style = document.createElement('style');
        style.id = 'usdt-anim-style';
        style.innerHTML = `
        @keyframes spin { 0%{transform:rotate(0);} 100%{transform:rotate(360deg);} }
        @keyframes ripple-anim { 0%{opacity:0.4;transform:scale(0);} 100%{opacity:0;transform:scale(1.2);} }
        .count-anim { animation: countJump 0.3s cubic-bezier(.4,2,.6,1); }
        @keyframes countJump { 0%{transform:scale(1);} 40%{transform:scale(1.25);} 100%{transform:scale(1);} }
        @keyframes fadeInModal { from{opacity:0;} to{opacity:1;} }
        @keyframes popInModal { 0%{transform:scale(0.7);} 80%{transform:scale(1.05);} 100%{transform:scale(1);} }
        `;
        document.head.appendChild(style);
    }

})();